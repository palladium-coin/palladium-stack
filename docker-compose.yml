networks:
  palladium-net:
    name: palladium-net  # fixed name, independent of the directory â€” other stacks can join with external: true

services:
  palladiumd:
    build:
      context: .
      dockerfile: Dockerfile.palladium-node
    image: palladium-node:local
    container_name: palladium-node
    restart: unless-stopped
    networks:
      - palladium-net
    ports:
      - "0.0.0.0:2333:2333"  # P2P port mainnet (accessible from network)
      # For testnet, expose: 12333 (P2P)
      # RPC (2332) and ZMQ (28332/28334/28335) are NOT exposed on the host.
      # Other Docker stacks on this host can reach them via palladium-net:
      #   palladiumd:2332  (RPC)
      #   palladiumd:28332 (ZMQ hashblock)
      #   palladiumd:28334 (ZMQ rawblock)
      #   palladiumd:28335 (ZMQ rawtx)

    volumes:
      # Mount .palladium folder (contains config and blockchain data)
      - ./.palladium:/root/.palladium

    command: >
      palladiumd
      -conf=/root/.palladium/palladium.conf
      -datadir=/root/.palladium
      -daemon=0
      -printtoconsole=1

  electrumx:
    build:
      context: .
      dockerfile: Dockerfile.electrumx
    image: electrumx-server:local
    container_name: electrumx-server
    restart: unless-stopped
    depends_on:
      - palladiumd
    networks:
      - palladium-net
    ports:
      - "0.0.0.0:50001:50001"  # TCP (accessible from network)
      - "0.0.0.0:50002:50002"  # SSL (accessible from network)

    environment:
      # ===== Network Configuration =====
      # For MAINNET use: COIN: "Palladium", NET: "mainnet"
      # For TESTNET use: COIN: "Palladium", NET: "testnet"

      COIN: "Palladium"  # Always "Palladium" for both networks
      NET: "mainnet"

      # NOTE: RPC credentials are automatically read from palladium.conf
      # No need to configure DAEMON_URL manually anymore!

      SERVICES: "tcp://0.0.0.0:50001,ssl://0.0.0.0:50002"

      SSL_CERTFILE: "/certs/server.crt"
      SSL_KEYFILE: "/certs/server.key"

      DB_DIRECTORY: "/data"
      PEER_DISCOVERY: "on"
      PEER_ANNOUNCE: "true"
      # REPORT_SERVICES is auto-detected at startup. Set manually only to override.
      # REPORT_SERVICES: "tcp://your.public.ip:50001,ssl://your.public.ip:50002"
      INITIAL_CONCURRENT: "2"
      COST_SOFT_LIMIT: "0"
      COST_HARD_LIMIT: "0"
      DONATION_ADDRESS: "plm1qdq3gu2zvg9lyr8gxd6yln4wavc5tlp8prmvfay"

    ulimits:
      nofile:
        soft: 1048576
        hard: 1048576

    volumes:
      - ./electrumx-data:/data
      - ./.palladium/palladium.conf:/palladium-config/palladium.conf:ro
      - ./certs:/certs

  dashboard:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    image: palladium-dashboard:local
    container_name: palladium-dashboard
    restart: unless-stopped
    depends_on:
      - palladiumd
      - electrumx
    networks:
      - palladium-net
    ports:
      - "0.0.0.0:8080:8080"  # Web Dashboard (accessible from network)

    environment:
      PALLADIUM_RPC_HOST: "palladiumd"
      PALLADIUM_RPC_PORT: "2332"
      ELECTRUMX_RPC_HOST: "electrumx"
      ELECTRUMX_RPC_PORT: "8000"
      DASHBOARD_AUTH_USERNAME: "${DASHBOARD_AUTH_USERNAME:-admin}"
      DASHBOARD_AUTH_PASSWORD: "${DASHBOARD_AUTH_PASSWORD:-change-me-now}"
      API_KEY: "${API_KEY:-}"

    volumes:
      - ./.palladium/palladium.conf:/palladium-config/palladium.conf:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
